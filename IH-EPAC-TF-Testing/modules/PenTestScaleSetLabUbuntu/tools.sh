#!/bin/bash
# Script to cleanly destroy Terraform-managed VMSS infrastructure
# This helps bypass dependency issues when running terraform destroy

set -e

# Get variables from terraform output
RESOURCE_GROUP=$(terraform output -raw resource_group_name)
VMSS_NAME=$(terraform output -raw vmss_name)
LB_NAME=$(terraform output -raw lb_name)

echo "Starting clean destroy for VMSS $VMSS_NAME in resource group $RESOURCE_GROUP"

# 1. Update VMSS to remove health probe reference
echo "Removing health probe reference from VMSS..."
az vmss update \
  --resource-group $RESOURCE_GROUP \
  --name $VMSS_NAME \
  --set virtualMachineProfile.networkProfile.healthProbe=null

# 2. Update VMSS to remove LB backend pool reference
echo "Removing load balancer backend pool reference from VMSS..."
az vmss update \
  --resource-group $RESOURCE_GROUP \
  --name $VMSS_NAME \
  --set 'virtualMachineProfile.networkProfile.networkInterfaceConfigurations[0].ipConfigurations[0].loadBalancerBackendAddressPools=[]'

# 3. Now run Terraform destroy
echo "Running terraform destroy..."
terraform destroy -auto-approve

echo "Clean destroy completed!"